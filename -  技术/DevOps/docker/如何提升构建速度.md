## 压缩镜像体积

## 利用镜像缓存

## 利用GO Cache
对于编译型语言，通常都有一些加速编译的机制，比如在 Go 的编译过程中，缓存机制主要体现在以下几个方面：

	1. **增量编译**：Go 的 `go build` 命令默认启用了缓存功能，使得在修改文件后重新编译时能够快速命中缓存，从而大幅缩短编译时间。例如，在一个大程序的测试中，全新编译耗时 107 秒，而仅需重新编译修改过的部分则只需 22 秒。
	    
	2. **依赖管理**：使用 `go mod download` 命令构建的缓存层包含了所有依赖项，如果 go.mod 或 go.sum 文件没有变化，则可以直接使用该缓存，避免了重复下载依赖项，加速了构建过程。
	    
	3. **缓存清理**：执行 `go clean -cache` 命令可以清除编译缓存，释放内存空间。这在长时间运行的项目中尤为重要，因为缓存会占用大量内存。
	    
	4. **缓存内容及计算方式**：Go 编译缓存会将影响当前编译结果的所有参数加入到计算哈希值的内容里，如工作目录（Work Dir）、Go 版本、编译的文件及其哈希值、import 文件及其哈希值等。
	    
	5. **工具支持**：一些第三方工具如 `go-fast` 提供了额外的优化手段来进一步提升编译速度。这些工具集包括 `go-fast-compile` 和 `go-fast-build`，专为优化 Go 项目编译速度而设计。
	    
	6. **缓存策略**：Go 编译器采用了先进的自动优化技术，包括内联优化、死码消除和逃逸分析等，这些优化技术也间接提高了编译效率。

具体 GO Cache 原理可用参考  https://www.cnblogs.com/liuscraft/p/18061863 

## 总结
下面总结了在构建阶段需要注意的点
1. dockerfile 不安装无效软件包 
2. 理想状态下，每个镜像应该只有一个进程 
3. 无法避免多进程运行时，应选择合理的初始化进程【1.需要捕获 SIGTERM 信号并完成子进程的优雅终止；2.负责清理退出的子进程以避免僵尸进程 --init 参数】 
4. 最小层级数：1.多条 RUN 命令可通过连接符连接成一条指令集以减少层数；2.通过多段构建减少镜像层数 
5. 多行参数按字母排序，可以减少可能出现的重复参数，并且提供可读性 
6. 把变更频率低的编译指令放在镜像底层，有效利用 build cache【考虑 build cache 下层失效，上层同步失效的机制】 
7. 复制文件时，每个文件应独立复制，确保某个文件变更时，只影响该文件对应的缓存
8. 对于 golang 包构建需要考虑 GoCache 提升编译速度
