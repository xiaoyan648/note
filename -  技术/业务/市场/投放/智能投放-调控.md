## 新媒体调控/同步整体流程

### 1. 媒体账户同步流程

入口命令：mkt account-media-sync

核心服务：JobAccountMediaSyncService

流程：

1. 获取媒体账户和应用列表（getMediaAccountAppList）

2. 遍历账户，调用媒体 API 拉取广告账户

3. 批量插入/更新广告账户（BatchCreate/SaveWithField）

4. 发布 Kafka 消息通知账户变更

关键文件：

- /Users/staff/code/market/genesis/internal/application/mkt/service/job_account_media_sync.go

- /Users/staff/code/market/genesis/cmd/mkt/job_account_media_sync.go

- /Users/staff/code/market/genesis/deploy/mkt/prod/cron/account-media-sync.yaml

---

### 2. 产品列表同步流程（product_list）

入口方式：

- 命令行：mkt mkt-pull --command=product-info --accountId=xxx -m=toutiao

- Kafka 消费者：MktPullConsumer 监听 mktp-mkt-pull-task topic

核心服务：MktPullService

数据流向：

1. 任务触发（命令行/Kafka）

   ↓

2. MktPullService.Pull()

   ↓

3. handleProductListRequest() - 调用头条API

   ↓

4. ProductListClient.Get() - 拉取产品列表

   ↓

5. handleProductDataProcess() - 数据处理

   ↓

6. MediaToutiaoProductRepository.BatchCreate() - 批量保存

关键文件：

- /Users/staff/code/market/genesis/internal/application/mkt/service/service_mkt_pull.go (166-180行, 343-369行)

- /Users/staff/code/market/genesis/internal/infra/remote/toutiao/product_list.go

- /Users/staff/code/market/genesis/internal/infra/repo/media_toutiao_product.go

API 调用细节：

- 使用头条 DpaDetailGetV2Api 接口

- 根据账户ID获取对应的 instanceID（商品库资产ID）

- 分页拉取，每页100条

- 对漫剧账户特殊处理，提取 AlbumID 和 PlayletID

---

### 3. AlbumID、PlayletID 字段处理

提取逻辑（product_list.go:74-105）：

// 仅对漫剧账户提取这些字段

func getPlayletIDIfIsMotionComic(accountID string, profession *map[string]string) 

判断条件：

- 通过 meta.IsMotionComicADAccount(accountID) 判断是否为漫剧账户

- 漫剧账户ID：1854347260793866（IAP）、1854528518086986（IAA）

提取过程：

1. 从 API 响应的 profession 字段中提取 album_id

2. 从 profession["album_link"] 的 URL 参数中提取 playlet_id

3. 解析失败时记录错误日志，但不中断流程

使用场景：

1. 任务执行时查询产品信息（job_run_task_instance_mc.go:328-353）：
    
       // 根据 PlayletID 查询产品信息
    
       q := reportEntity.NewMediaToutiaoProductQuery().
    
           WithPlayletIDs(playletIDs).
    
           WithPlatformID(platformID).
    
           WithBusinessID(businessConfigItem.BusinessID)
    

2. 数据库存储：

- 表：media_toutiao_product

- 字段：album_id（短剧ID）、playlet_id（漫剧ID）

- 更新策略：ON CONFLICT 时更新 album_id、playlet_id

关键文件：

- /Users/staff/code/market/genesis/internal/infra/remote/toutiao/product_list.go (74-131行)

- /Users/staff/code/market/genesis/internal/domain/report/entity/media_toutiao_product.go

- /Users/staff/code/market/genesis/internal/application/ad/service/job_run_task_instance_mc.go (328-353行)

---

### 4. media_sync 相关任务和命令

定时任务（CronJob）：

1. 账户同步任务：

- 文件：deploy/mkt/prod/cron/account-media-sync.yaml

- 调度：每小时执行一次（0 * * * *）

- 命令：mkt account-media-sync

1. 产品列表同步任务：

- 文件：deploy/mkt/prod/cron/toutiao-product.yaml

- 调度：每天 00:30 执行（30 0 * * *）

- 命令：mkt mkt-pull --command=product-info --accountId=xxx -m=toutiao

Kafka 消费者：

1. 新媒体数据拉取消费者：

- Topic：mktp-mkt-pull-task

- 服务：MktPullConsumer

- 文件：internal/application/mkt/service/consumer_new_media_mkt_pull.go

1. 漫剧数据拉取消费者：

- Topic：mktp-motion-comic-mkt-pull-task

- 服务：MotionComicMktPullConsumer

- 文件：internal/application/mkt/service/consumer_motion_comic_mkt_pull.go

命令列表：

|命令|功能|文件|
|---|---|---|
|mkt account-media-sync|同步媒体账户列表|cmd/mkt/job_account_media_sync.go|
|mkt mkt-pull|拉取营销数据（支持多种类型）|cmd/mkt/job_mkt_pull.go|
|mkt mkt-pull-consumer|消费新媒体拉取任务|cmd/mkt/consumer_new_media_mkt_pull.go|
|mkt motion-comic-mkt-pull-consumer|消费漫剧拉取任务|cmd/mkt/consumer_motion_comic_mkt_pull.go|

---

## 关键文件和函数汇总

### 核心服务层

- internal/application/mkt/service/job_account_media_sync.go - 媒体账户同步服务

- internal/application/mkt/service/service_mkt_pull.go - 数据拉取服务

- internal/application/mkt/service/job_report_list.go - 报表列表任务服务

### 远程调用层

- internal/infra/remote/toutiao/product_list.go - 头条产品列表API客户端

- internal/infra/remote/toutiao/client.go - 头条API基础客户端

### 数据访问层

- internal/infra/repo/media_toutiao_product.go - 产品数据仓库

- internal/infra/repo/media_mkt_data.go - 营销数据仓库

### 领域模型层

- internal/domain/report/entity/media_toutiao_product.go - 产品实体定义

- internal/domain/report/entity/daily_report.go - 报表实体（包含ProductList）

- internal/domain/account/meta/media_ad_account.go - 账户元数据

### 任务执行层

- internal/application/ad/service/job_run_task_instance_mc.go - 漫剧任务执行服务（使用PlayletID查询）

---

## 数据流向图

┌─────────────────┐

│ 定时任务/Kafka  │

└────────┬────────┘

         │

         ▼

┌─────────────────────────┐

│  JobAccountMediaSync    │ 媒体账户同步

│  / MktPullService       │ 数据拉取服务

└────────┬────────────────┘

         │

         ▼

┌─────────────────────────┐

│  ProductListClient.Get() │ 调用头条API

│  (提取AlbumID/PlayletID) │

└────────┬────────────────┘

         │

         ▼

┌─────────────────────────┐

│ handleProductDataProcess │ 数据处理转换

└────────┬────────────────┘

         │

         ▼

┌─────────────────────────┐

│ MediaToutiaoProductRepo  │ 批量保存到数据库

│ .BatchCreate()          │

└────────┬────────────────┘

         │

         ▼

┌─────────────────────────┐

│  job_run_task_instance  │ 任务执行时查询使用

│  (通过PlayletID查询)     │

└─────────────────────────┘

以上为新媒体调控/同步的整体流程和关键代码位置。